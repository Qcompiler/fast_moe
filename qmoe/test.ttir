#loc = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":428:0)
#loc3 = loc(unknown)
#loc27 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":459:20)
#loc37 = loc("A_ptr"(#loc))
#loc38 = loc("x_ptr"(#loc))
#loc39 = loc("y_ptr"(#loc))
#loc40 = loc("m"(#loc))
#loc41 = loc("k"(#loc))
#loc42 = loc("int4_k"(#loc))
#loc43 = loc("stride_am"(#loc))
#loc66 = loc("acc"(#loc27))
#loc75 = loc(callsite(#loc3 at #loc66))
module {
  tt.func public @test_dequant_kernel(%A_ptr: !tt.ptr<i32> {tt.divisibility = 16 : i32} loc("A_ptr"(#loc)), %x_ptr: !tt.ptr<i64> {tt.divisibility = 16 : i32} loc("x_ptr"(#loc)), %y_ptr: !tt.ptr<f16> {tt.divisibility = 16 : i32} loc("y_ptr"(#loc)), %m: i32 {tt.divisibility = 16 : i32} loc("m"(#loc)), %k: i32 {tt.divisibility = 16 : i32} loc("k"(#loc)), %int4_k: i32 {tt.divisibility = 16 : i32} loc("int4_k"(#loc)), %stride_am: i32 {tt.divisibility = 16 : i32} loc("stride_am"(#loc))) attributes {noinline = false} {
    %c255_i32 = arith.constant 255 : i32 loc(#loc44)
    %c256_i32 = arith.constant 256 : i32 loc(#loc45)
    %c1_i32 = arith.constant 1 : i32 loc(#loc4)
    %c0_i32 = arith.constant 0 : i32 loc(#loc4)
    %acc = arith.constant 0.000000e+00 : f16 loc(#loc46)
    %cst = arith.constant dense<512> : tensor<256xi32> loc(#loc3)
    %cst_0 = arith.constant dense<256> : tensor<256xi32> loc(#loc3)
    %cst_1 = arith.constant dense<8> : tensor<256xi32> loc(#loc3)
    %x_ptr_2 = arith.constant dense<2> : tensor<256xi32> loc(#loc47)
    %row_id = tt.get_program_id x : i32 loc(#loc48)
    %offs_k = tt.make_range {end = 256 : i32, start = 0 : i32} : tensor<256xi32> loc(#loc49)
    %A_offset = arith.muli %row_id, %stride_am : i32 loc(#loc50)
    %A_offset_3 = tt.splat %A_offset : i32 -> tensor<256xi32> loc(#loc51)
    %A_offset_4 = arith.addi %A_offset_3, %offs_k : tensor<256xi32> loc(#loc51)
    %A_ptr_5 = tt.splat %A_ptr : !tt.ptr<i32> -> tensor<256x!tt.ptr<i32>> loc(#loc52)
    %A_ptr_6 = tt.addptr %A_ptr_5, %A_offset_4 : tensor<256x!tt.ptr<i32>>, tensor<256xi32> loc(#loc52)
    %x_ptr_7 = arith.muli %offs_k, %x_ptr_2 : tensor<256xi32> loc(#loc47)
    %x_ptr_8 = tt.splat %x_ptr : !tt.ptr<i64> -> tensor<256x!tt.ptr<i64>> loc(#loc53)
    %x_ptr_9 = tt.addptr %x_ptr_8, %x_ptr_7 : tensor<256x!tt.ptr<i64>>, tensor<256xi32> loc(#loc53)
    %0 = arith.addi %int4_k, %c255_i32 : i32 loc(#loc44)
    %1 = arith.divsi %0, %c256_i32 : i32 loc(#loc54)
    %offs_k_10:4 = scf.for %kk = %c0_i32 to %1 step %c1_i32 iter_args(%A_ptr_11 = %A_ptr_6, %x_ptr_12 = %x_ptr_9, %acc_13 = %acc, %offs_k_14 = %offs_k) -> (tensor<256x!tt.ptr<i32>>, tensor<256x!tt.ptr<i64>>, f16, tensor<256xi32>)  : i32 {
      %mask = tt.splat %int4_k : i32 -> tensor<256xi32> loc(#loc56)
      %mask_15 = arith.cmpi slt, %offs_k_14, %mask : tensor<256xi32> loc(#loc56)
      %3:4 = tt.elementwise_inline_asm "ld.global.v4.u32 {$0,$1,$2,$3}, [$4];" {constraints = "=r,=r,=r,=r,l", packed_element = 1 : i32, pure = false} %x_ptr_12 : tensor<256x!tt.ptr<i64>> -> tensor<256xi32>, tensor<256xi32>, tensor<256xi32>, tensor<256xi32> loc(#loc57)
      %a = tt.load %A_ptr_11, %mask_15 evictionPolicy = evict_last : tensor<256x!tt.ptr<i32>> loc(#loc58)
      %4:2 = tt.elementwise_inline_asm "\0A            {\0A            .reg .b32 \09r<16>;\0A            .reg .b32  r_high<2>, r_low<2>;\0A\0A\09          .reg .b64 \09rd<2>;\0A            .reg .u16 tmp1, tmp2, tmp3, tmp4;\0A\0A            mov.u32 r2, $2;\0A            mov.u32 \09r3, 983055;\0A            mov.u32 \09r8, 1677747200;\0A            lop3.b32 r1, r2, r3, r8, 234;\0A            mov.u32 \09r7, 15728880;\0A            lop3.b32 r5, r2, r7, r8, 234;\0A            mov.u32 \09r11, 1678271496;\0A            mov.u32 \09r14, 738208768;\0A            mov.u32 \09r15, -729754496;\0A            fma.rn.f16x2 r12,r5,r14,r15;\0A            sub.f16x2 r9,r1,r11;\0A\0A            shr.s32   r_high1, r9, 16;\0A            cvt.u16.u32   tmp1, r_high1;\0A            and.b32       r_low1, r9, 0xFFFF;\0A            cvt.u16.u32   tmp2, r_low1;\0A\0A            shr.s32   r_high1, r12, 16;\0A            cvt.u16.u32   tmp3, r_high1;\0A            and.b32       r_low1, r12, 0xFFFF;\0A            cvt.u16.u32   tmp4, r_low1;\0A\0A            mov.b32 $1, {tmp4, tmp3};   \0A            mov.b32 $0, {tmp2, tmp1};  \0A            }\0A        " {constraints = "=r,=r,r", packed_element = 1 : i32, pure = false} %a : tensor<256xi32> -> tensor<256xi32>, tensor<256xi32> loc(#loc59)
      %y = tt.elementwise_inline_asm "\0A            {\0A              .reg .b32 vec1, vec2, vec_sum;\0A              .reg .b16 h_low, h_high, h_final;\0A              .reg .b32 x1, x2;\0A\0A              mov.b32 vec1, $1;\0A              mov.b32 vec2, $2;\0A              mov.b32 x1, $3;\0A              mov.b32 x2, $4;\0A\0A              mul.f16x2 vec1, vec1, x1;\0A              mul.f16x2 vec2, vec2, x2;\0A              add.f16x2 vec_sum, vec1, vec2;\0A              mov.b32 {h_high, h_low}, vec_sum; \0A              add.f16 h_final, h_high, h_low;              \0A              cvt.u16.u16 $0,  h_final;\0A\0A            }\0A        " {constraints = "=f,r,r,r,r", packed_element = 1 : i32, pure = false} %4#0, %4#1, %3#0, %3#1 : tensor<256xi32>, tensor<256xi32>, tensor<256xi32>, tensor<256xi32> -> tensor<256xf16> loc(#loc72)
      %a_16 = arith.shrsi %a, %cst_1 : tensor<256xi32> loc(#loc62)
      %5:2 = tt.elementwise_inline_asm "\0A            {\0A            .reg .b32 \09r<16>;\0A            .reg .b32  r_high<2>, r_low<2>;\0A\0A\09          .reg .b64 \09rd<2>;\0A            .reg .u16 tmp1, tmp2, tmp3, tmp4;\0A\0A            mov.u32 r2, $2;\0A            mov.u32 \09r3, 983055;\0A            mov.u32 \09r8, 1677747200;\0A            lop3.b32 r1, r2, r3, r8, 234;\0A            mov.u32 \09r7, 15728880;\0A            lop3.b32 r5, r2, r7, r8, 234;\0A            mov.u32 \09r11, 1678271496;\0A            mov.u32 \09r14, 738208768;\0A            mov.u32 \09r15, -729754496;\0A            fma.rn.f16x2 r12,r5,r14,r15;\0A            sub.f16x2 r9,r1,r11;\0A\0A            shr.s32   r_high1, r9, 16;\0A            cvt.u16.u32   tmp1, r_high1;\0A            and.b32       r_low1, r9, 0xFFFF;\0A            cvt.u16.u32   tmp2, r_low1;\0A\0A            shr.s32   r_high1, r12, 16;\0A            cvt.u16.u32   tmp3, r_high1;\0A            and.b32       r_low1, r12, 0xFFFF;\0A            cvt.u16.u32   tmp4, r_low1;\0A\0A            mov.b32 $1, {tmp4, tmp3};   \0A            mov.b32 $0, {tmp2, tmp1};  \0A            }\0A        " {constraints = "=r,=r,r", packed_element = 1 : i32, pure = false} %a_16 : tensor<256xi32> -> tensor<256xi32>, tensor<256xi32> loc(#loc63)
      %y_17 = tt.elementwise_inline_asm "\0A            {\0A              .reg .b32 vec1, vec2, vec_sum;\0A              .reg .b16 h_low, h_high, h_final;\0A              .reg .b32 x1, x2;\0A\0A              mov.b32 vec1, $1;\0A              mov.b32 vec2, $2;\0A              mov.b32 x1, $3;\0A              mov.b32 x2, $4;\0A\0A              mul.f16x2 vec1, vec1, x1;\0A              mul.f16x2 vec2, vec2, x2;\0A              add.f16x2 vec_sum, vec1, vec2;\0A              mov.b32 {h_high, h_low}, vec_sum; \0A              add.f16 h_final, h_high, h_low;              \0A              cvt.u16.u16 $0,  h_final;\0A\0A            }\0A        " {constraints = "=f,r,r,r,r", packed_element = 1 : i32, pure = false} %5#0, %5#1, %3#2, %3#3 : tensor<256xi32>, tensor<256xi32>, tensor<256xi32>, tensor<256xi32> -> tensor<256xf16> loc(#loc73)
      %acc_18 = arith.addf %y, %y_17 : tensor<256xf16> loc(#loc65)
      %acc_19 = "tt.reduce"(%acc_18) <{axis = 0 : i32}> ({
      ^bb0(%acc_24: f16 loc(callsite(#loc3 at #loc66)), %acc_25: f16 loc(callsite(#loc3 at #loc66))):
        %acc_26 = arith.addf %acc_24, %acc_25 : f16 loc(#loc77)
        tt.reduce.return %acc_26 : f16 loc(#loc74)
      }) : (tensor<256xf16>) -> f16 loc(#loc74)
      %acc_20 = arith.addf %acc_13, %acc_19 : f16 loc(#loc67)
      %offs_k_21 = arith.addi %offs_k_14, %cst_0 : tensor<256xi32> loc(#loc68)
      %A_ptr_22 = tt.addptr %A_ptr_11, %cst_0 : tensor<256x!tt.ptr<i32>>, tensor<256xi32> loc(#loc69)
      %x_ptr_23 = tt.addptr %x_ptr_12, %cst : tensor<256x!tt.ptr<i64>>, tensor<256xi32> loc(#loc70)
      scf.yield %A_ptr_22, %x_ptr_23, %acc_20, %offs_k_21 : tensor<256x!tt.ptr<i32>>, tensor<256x!tt.ptr<i64>>, f16, tensor<256xi32> loc(#loc33)
    } loc(#loc78)
    %2 = tt.addptr %y_ptr, %row_id : !tt.ptr<f16>, i32 loc(#loc34)
    tt.store %2, %offs_k_10#2 : !tt.ptr<f16> loc(#loc35)
    tt.return loc(#loc36)
  } loc(#loc)
} loc(#loc)
#loc1 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":41:22)
#loc2 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":449:39)
#loc4 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":449:23)
#loc5 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":440:17)
#loc6 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":447:30)
#loc7 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":438:27)
#loc8 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":443:27)
#loc9 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":444:24)
#loc10 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":444:36)
#loc11 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":446:20)
#loc12 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":447:21)
#loc13 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":41:28)
#loc14 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":450:22)
#loc15 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":397:8)
#loc16 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":451:35)
#loc17 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":452:18)
#loc18 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":342:8)
#loc19 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":453:24)
#loc20 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":383:8)
#loc21 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":454:36)
#loc22 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":455:15)
#loc23 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":456:24)
#loc24 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":457:36)
#loc25 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":459:27)
#loc26 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":291:36)
#loc28 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":261:15)
#loc29 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":459:13)
#loc30 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":460:17)
#loc31 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":461:16)
#loc32 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":462:16)
#loc33 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":462:6)
#loc34 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":464:21)
#loc35 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":464:29)
#loc36 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":464:4)
#loc44 = loc(callsite(#loc1 at #loc2))
#loc45 = loc(callsite(#loc3 at #loc2))
#loc46 = loc("acc"(#loc5))
#loc47 = loc("x_ptr"(#loc6))
#loc48 = loc("row_id"(#loc7))
#loc49 = loc("offs_k"(#loc8))
#loc50 = loc("A_offset"(#loc9))
#loc51 = loc("A_offset"(#loc10))
#loc52 = loc("A_ptr"(#loc11))
#loc53 = loc("x_ptr"(#loc12))
#loc54 = loc(callsite(#loc13 at #loc2))
#loc55 = loc("A_ptr"(#loc4))
#loc56 = loc("mask"(#loc14))
#loc57 = loc(callsite(#loc15 at #loc16))
#loc58 = loc("a"(#loc17))
#loc59 = loc(callsite(#loc18 at #loc19))
#loc60 = loc("y"(#loc20))
#loc61 = loc("all1"(#loc21))
#loc62 = loc("a"(#loc22))
#loc63 = loc(callsite(#loc18 at #loc23))
#loc64 = loc("all2"(#loc24))
#loc65 = loc("acc"(#loc25))
#loc67 = loc("acc"(#loc29))
#loc68 = loc("offs_k"(#loc30))
#loc69 = loc("A_ptr"(#loc31))
#loc70 = loc("x_ptr"(#loc32))
#loc71 = loc("x_ptr"(#loc55))
#loc72 = loc(callsite(#loc60 at #loc61))
#loc73 = loc(callsite(#loc60 at #loc64))
#loc74 = loc(callsite(#loc26 at #loc66))
#loc76 = loc("acc"(#loc71))
#loc77 = loc(callsite(#loc28 at #loc74))
#loc78 = loc("offs_k"(#loc76))
