#blocked = #ttg.blocked<{sizePerThread = [2], threadsPerWarp = [32], warpsPerCTA = [4], order = [0]}>
#blocked1 = #ttg.blocked<{sizePerThread = [1], threadsPerWarp = [32], warpsPerCTA = [4], order = [0]}>
#loc = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":422:0)
#loc1 = loc(unknown)
#loc26 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":453:20)
#loc36 = loc("A_ptr"(#loc))
#loc37 = loc("x_ptr"(#loc))
#loc38 = loc("y_ptr"(#loc))
#loc39 = loc("m"(#loc))
#loc40 = loc("k"(#loc))
#loc41 = loc("int4_k"(#loc))
#loc42 = loc("stride_am"(#loc))
#loc63 = loc("acc"(#loc26))
#loc72 = loc(callsite(#loc1 at #loc63))
module attributes {"ttg.num-ctas" = 1 : i32, "ttg.num-warps" = 4 : i32, ttg.target = "cuda:90", "ttg.threads-per-warp" = 32 : i32} {
  tt.func public @test_dequant_kernel(%A_ptr: !tt.ptr<i32> {tt.divisibility = 16 : i32} loc("A_ptr"(#loc)), %x_ptr: !tt.ptr<i64> {tt.divisibility = 16 : i32} loc("x_ptr"(#loc)), %y_ptr: !tt.ptr<f16> {tt.divisibility = 16 : i32} loc("y_ptr"(#loc)), %m: i32 {tt.divisibility = 16 : i32} loc("m"(#loc)), %k: i32 {tt.divisibility = 16 : i32} loc("k"(#loc)), %int4_k: i32 {tt.divisibility = 16 : i32} loc("int4_k"(#loc)), %stride_am: i32 {tt.divisibility = 16 : i32} loc("stride_am"(#loc))) attributes {noinline = false} {
    %cst = arith.constant dense<256> : tensor<256xi32, #blocked> loc(#loc1)
    %cst_0 = arith.constant dense<512> : tensor<256xi32, #blocked> loc(#loc1)
    %cst_1 = arith.constant dense<2> : tensor<256xi32, #blocked> loc(#loc1)
    %cst_2 = arith.constant dense<2> : tensor<256xi32, #blocked1> loc(#loc1)
    %c255_i32 = arith.constant 255 : i32 loc(#loc1)
    %c256_i32 = arith.constant 256 : i32 loc(#loc1)
    %c1_i32 = arith.constant 1 : i32 loc(#loc1)
    %c0_i32 = arith.constant 0 : i32 loc(#loc1)
    %cst_3 = arith.constant 0.000000e+00 : f16 loc(#loc1)
    %cst_4 = arith.constant dense<512> : tensor<256xi32, #blocked1> loc(#loc1)
    %cst_5 = arith.constant dense<8> : tensor<256xi32, #blocked> loc(#loc1)
    %row_id = tt.get_program_id x : i32 loc(#loc43)
    %offs_k = tt.make_range {end = 256 : i32, start = 0 : i32} : tensor<256xi32, #blocked> loc(#loc44)
    %offs_k_6 = tt.make_range {end = 256 : i32, start = 0 : i32} : tensor<256xi32, #blocked1> loc(#loc44)
    %A_offset = arith.muli %row_id, %stride_am : i32 loc(#loc45)
    %A_offset_7 = tt.splat %A_offset : i32 -> tensor<256xi32, #blocked> loc(#loc46)
    %A_offset_8 = arith.addi %A_offset_7, %offs_k : tensor<256xi32, #blocked> loc(#loc46)
    %A_ptr_9 = tt.splat %A_ptr : !tt.ptr<i32> -> tensor<256x!tt.ptr<i32>, #blocked> loc(#loc47)
    %A_ptr_10 = tt.addptr %A_ptr_9, %A_offset_8 : tensor<256x!tt.ptr<i32>, #blocked>, tensor<256xi32, #blocked> loc(#loc47)
    %x_ptr_11 = arith.muli %offs_k, %cst_1 : tensor<256xi32, #blocked> loc(#loc48)
    %x_ptr_12 = arith.muli %offs_k_6, %cst_2 : tensor<256xi32, #blocked1> loc(#loc48)
    %x_ptr_13 = tt.splat %x_ptr : !tt.ptr<i64> -> tensor<256x!tt.ptr<i64>, #blocked> loc(#loc49)
    %x_ptr_14 = tt.splat %x_ptr : !tt.ptr<i64> -> tensor<256x!tt.ptr<i64>, #blocked1> loc(#loc49)
    %x_ptr_15 = tt.addptr %x_ptr_13, %x_ptr_11 : tensor<256x!tt.ptr<i64>, #blocked>, tensor<256xi32, #blocked> loc(#loc49)
    %x_ptr_16 = tt.addptr %x_ptr_14, %x_ptr_12 : tensor<256x!tt.ptr<i64>, #blocked1>, tensor<256xi32, #blocked1> loc(#loc49)
    %0 = arith.addi %int4_k, %c255_i32 : i32 loc(#loc50)
    %1 = arith.divsi %0, %c256_i32 : i32 loc(#loc51)
    %mask = tt.splat %int4_k : i32 -> tensor<256xi32, #blocked> loc(#loc52)
    %offs_k_17:5 = scf.for %offs_k_18 = %c0_i32 to %1 step %c1_i32 iter_args(%x_ptr_19 = %x_ptr_16, %acc = %cst_3, %x_ptr_20 = %x_ptr_15, %A_ptr_21 = %A_ptr_10, %offs_k_22 = %offs_k) -> (tensor<256x!tt.ptr<i64>, #blocked1>, f16, tensor<256x!tt.ptr<i64>, #blocked>, tensor<256x!tt.ptr<i32>, #blocked>, tensor<256xi32, #blocked>)  : i32 {
      %mask_23 = arith.cmpi slt, %offs_k_22, %mask : tensor<256xi32, #blocked> loc(#loc52)
      %3:4 = tt.elementwise_inline_asm "ld.global.v4.u32 {$0,$1,$2,$3}, [$4];" {constraints = "=r,=r,=r,=r,l", packed_element = 1 : i32, pure = false} %x_ptr_20 : tensor<256x!tt.ptr<i64>, #blocked> -> tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked> loc(#loc54)
      %4:4 = tt.elementwise_inline_asm "ld.global.v4.u32 {$0,$1,$2,$3}, [$4];" {constraints = "=r,=r,=r,=r,l", packed_element = 1 : i32, pure = false} %x_ptr_19 : tensor<256x!tt.ptr<i64>, #blocked1> -> tensor<256xi32, #blocked1>, tensor<256xi32, #blocked1>, tensor<256xi32, #blocked1>, tensor<256xi32, #blocked1> loc(#loc54)
      %a = tt.load %A_ptr_21, %mask_23 evictionPolicy = evict_last : tensor<256x!tt.ptr<i32>, #blocked> loc(#loc55)
      %5:2 = tt.elementwise_inline_asm "\0A            {\0A            .reg .b32 \09r<16>;\0A            .reg .b32  r_high<2>, r_low<2>;\0A\09          .reg .b64 \09rd<2>;\0A            .reg .u16 tmp1, tmp2, tmp3, tmp4;            \0A            mov.u32 r2, $2;\0A            mov.u32 \09r3, 983055;\0A            mov.u32 \09r8, 1677747200;\0A            lop3.b32 r1, r2, r3, r8, 234;\0A            mov.u32 \09r7, 15728880;\0A            lop3.b32 r5, r2, r7, r8, 234;\0A            mov.u32 \09r11, 1678271496;\0A            mov.u32 \09r14, 738208768;\0A            mov.u32 \09r15, -729754496;\0A            fma.rn.f16x2 r12,r5,r14,r15;\0A            sub.f16x2 r9,r1,r11;            \0A            shr.s32   r_high1, r9, 16;\0A            cvt.u16.u32   tmp1, r_high1;\0A            and.b32       r_low1, r9, 0xFFFF;\0A            cvt.u16.u32   tmp2, r_low1;\0A            shr.s32   r_high1, r12, 16;\0A            cvt.u16.u32   tmp3, r_high1;\0A            and.b32       r_low1, r12, 0xFFFF;\0A            cvt.u16.u32   tmp4, r_low1;\0A            mov.b32 $1, {tmp4, tmp3};   \0A            mov.b32 $0, {tmp2, tmp1};  \0A            }\0A        " {constraints = "=r,=r,r", packed_element = 1 : i32, pure = false} %a : tensor<256xi32, #blocked> -> tensor<256xi32, #blocked>, tensor<256xi32, #blocked> loc(#loc56)
      %y = tt.elementwise_inline_asm "\0A            {\0A              .reg .b32 vec1, vec2, vec_sum;\0A              .reg .b16 h_low, h_high, h_final;\0A              .reg .b32 x1, x2;\0A\0A              mov.b32 vec1, $1;\0A              mov.b32 vec2, $2;\0A              mov.b32 x1, $3;\0A              mov.b32 x2, $4;\0A\0A              mul.f16x2 vec1, vec1, x1;\0A              mul.f16x2 vec2, vec2, x2;\0A              add.f16x2 vec_sum, vec1, vec2;\0A              mov.b32 {h_high, h_low}, vec_sum; \0A              add.f16 h_final, h_high, h_low;              \0A              cvt.u16.u16 $0,  h_final;\0A\0A            }\0A        " {constraints = "=f,r,r,r,r", packed_element = 1 : i32, pure = false} %5#0, %5#1, %3#0, %3#1 : tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked> -> tensor<256xf16, #blocked> loc(#loc69)
      %a_24 = arith.shrsi %a, %cst_5 : tensor<256xi32, #blocked> loc(#loc59)
      %6:2 = tt.elementwise_inline_asm "\0A            {\0A            .reg .b32 \09r<16>;\0A            .reg .b32  r_high<2>, r_low<2>;\0A\09          .reg .b64 \09rd<2>;\0A            .reg .u16 tmp1, tmp2, tmp3, tmp4;            \0A            mov.u32 r2, $2;\0A            mov.u32 \09r3, 983055;\0A            mov.u32 \09r8, 1677747200;\0A            lop3.b32 r1, r2, r3, r8, 234;\0A            mov.u32 \09r7, 15728880;\0A            lop3.b32 r5, r2, r7, r8, 234;\0A            mov.u32 \09r11, 1678271496;\0A            mov.u32 \09r14, 738208768;\0A            mov.u32 \09r15, -729754496;\0A            fma.rn.f16x2 r12,r5,r14,r15;\0A            sub.f16x2 r9,r1,r11;            \0A            shr.s32   r_high1, r9, 16;\0A            cvt.u16.u32   tmp1, r_high1;\0A            and.b32       r_low1, r9, 0xFFFF;\0A            cvt.u16.u32   tmp2, r_low1;\0A            shr.s32   r_high1, r12, 16;\0A            cvt.u16.u32   tmp3, r_high1;\0A            and.b32       r_low1, r12, 0xFFFF;\0A            cvt.u16.u32   tmp4, r_low1;\0A            mov.b32 $1, {tmp4, tmp3};   \0A            mov.b32 $0, {tmp2, tmp1};  \0A            }\0A        " {constraints = "=r,=r,r", packed_element = 1 : i32, pure = false} %a_24 : tensor<256xi32, #blocked> -> tensor<256xi32, #blocked>, tensor<256xi32, #blocked> loc(#loc60)
      %y_25 = tt.elementwise_inline_asm "\0A            {\0A              .reg .b32 vec1, vec2, vec_sum;\0A              .reg .b16 h_low, h_high, h_final;\0A              .reg .b32 x1, x2;\0A\0A              mov.b32 vec1, $1;\0A              mov.b32 vec2, $2;\0A              mov.b32 x1, $3;\0A              mov.b32 x2, $4;\0A\0A              mul.f16x2 vec1, vec1, x1;\0A              mul.f16x2 vec2, vec2, x2;\0A              add.f16x2 vec_sum, vec1, vec2;\0A              mov.b32 {h_high, h_low}, vec_sum; \0A              add.f16 h_final, h_high, h_low;              \0A              cvt.u16.u16 $0,  h_final;\0A\0A            }\0A        " {constraints = "=f,r,r,r,r", packed_element = 1 : i32, pure = false} %6#0, %6#1, %3#2, %3#3 : tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked>, tensor<256xi32, #blocked> -> tensor<256xf16, #blocked> loc(#loc70)
      %acc_26 = arith.addf %y, %y_25 : tensor<256xf16, #blocked> loc(#loc62)
      %acc_27 = "tt.reduce"(%acc_26) <{axis = 0 : i32}> ({
      ^bb0(%acc_33: f16 loc(callsite(#loc1 at #loc63)), %acc_34: f16 loc(callsite(#loc1 at #loc63))):
        %acc_35 = arith.addf %acc_33, %acc_34 : f16 loc(#loc74)
        tt.reduce.return %acc_35 : f16 loc(#loc71)
      }) : (tensor<256xf16, #blocked>) -> f16 loc(#loc71)
      %acc_28 = arith.addf %acc, %acc_27 : f16 loc(#loc64)
      %offs_k_29 = arith.addi %offs_k_22, %cst : tensor<256xi32, #blocked> loc(#loc65)
      %A_ptr_30 = tt.addptr %A_ptr_21, %cst : tensor<256x!tt.ptr<i32>, #blocked>, tensor<256xi32, #blocked> loc(#loc66)
      %x_ptr_31 = tt.addptr %x_ptr_20, %cst_0 : tensor<256x!tt.ptr<i64>, #blocked>, tensor<256xi32, #blocked> loc(#loc67)
      %x_ptr_32 = tt.addptr %x_ptr_19, %cst_4 : tensor<256x!tt.ptr<i64>, #blocked1>, tensor<256xi32, #blocked1> loc(#loc67)
      scf.yield %x_ptr_32, %acc_28, %x_ptr_31, %A_ptr_30, %offs_k_29 : tensor<256x!tt.ptr<i64>, #blocked1>, f16, tensor<256x!tt.ptr<i64>, #blocked>, tensor<256x!tt.ptr<i32>, #blocked>, tensor<256xi32, #blocked> loc(#loc32)
    } loc(#loc75)
    %2 = tt.addptr %y_ptr, %row_id : !tt.ptr<f16>, i32 loc(#loc33)
    tt.store %2, %offs_k_17#1 : !tt.ptr<f16> loc(#loc34)
    tt.return loc(#loc35)
  } loc(#loc)
} loc(#loc)
#loc2 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":432:27)
#loc3 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":437:27)
#loc4 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":438:24)
#loc5 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":438:37)
#loc6 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":440:20)
#loc7 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":441:30)
#loc8 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":441:21)
#loc9 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":41:22)
#loc10 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":443:39)
#loc11 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":41:28)
#loc12 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":444:22)
#loc13 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":443:23)
#loc14 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":391:8)
#loc15 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":445:35)
#loc16 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":446:18)
#loc17 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":338:8)
#loc18 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":447:24)
#loc19 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":377:8)
#loc20 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":448:36)
#loc21 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":449:15)
#loc22 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":450:24)
#loc23 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":451:36)
#loc24 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":453:27)
#loc25 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":291:36)
#loc27 = loc("/home/chenyidong/anaconda3/envs/dsl/lib/python3.11/site-packages/triton/language/standard.py":261:15)
#loc28 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":453:13)
#loc29 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":454:17)
#loc30 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":455:16)
#loc31 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":456:16)
#loc32 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":456:6)
#loc33 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":458:21)
#loc34 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":458:29)
#loc35 = loc("/home/chenyidong/newstart/bandwidth/qmoe/test_gemv_int4_triton_inline_ptx.py":458:4)
#loc43 = loc("row_id"(#loc2))
#loc44 = loc("offs_k"(#loc3))
#loc45 = loc("A_offset"(#loc4))
#loc46 = loc("A_offset"(#loc5))
#loc47 = loc("A_ptr"(#loc6))
#loc48 = loc("x_ptr"(#loc7))
#loc49 = loc("x_ptr"(#loc8))
#loc50 = loc(callsite(#loc9 at #loc10))
#loc51 = loc(callsite(#loc11 at #loc10))
#loc52 = loc("mask"(#loc12))
#loc53 = loc("A_ptr"(#loc13))
#loc54 = loc(callsite(#loc14 at #loc15))
#loc55 = loc("a"(#loc16))
#loc56 = loc(callsite(#loc17 at #loc18))
#loc57 = loc("y"(#loc19))
#loc58 = loc("all1"(#loc20))
#loc59 = loc("a"(#loc21))
#loc60 = loc(callsite(#loc17 at #loc22))
#loc61 = loc("all2"(#loc23))
#loc62 = loc("acc"(#loc24))
#loc64 = loc("acc"(#loc28))
#loc65 = loc("offs_k"(#loc29))
#loc66 = loc("A_ptr"(#loc30))
#loc67 = loc("x_ptr"(#loc31))
#loc68 = loc("x_ptr"(#loc53))
#loc69 = loc(callsite(#loc57 at #loc58))
#loc70 = loc(callsite(#loc57 at #loc61))
#loc71 = loc(callsite(#loc25 at #loc63))
#loc73 = loc("acc"(#loc68))
#loc74 = loc(callsite(#loc27 at #loc71))
#loc75 = loc("offs_k"(#loc73))
